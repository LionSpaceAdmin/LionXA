**Production Runbook**

- Purpose: deploy Xagent for production use with a headless browser and the dashboard server, separated from local development flows.

**Services**
- UI (Next.js):
  - Build: `pnpm build`
  - Start: `pnpm start` (defaults to port 3000; set `PORT_UI` to override)
- Agent + Dashboard:
  - Start (headless + safe flags): `pnpm start:agent:prod`
  - Dashboard listens on `DASHBOARD_PORT` (default 3001)
- Combined start (UI + Agent): `pnpm start:all`

**Environment**
- Required secrets:
  - `GEMINI_API_KEY` (or set `DRY_RUN=1` for simulation)
- Recommended:
  - `TWITTER_LIST_URL` or `START_URL`
  - `INTERACTIVE=0` and `HEADLESS_BROWSER=true` (already enforced by `start:agent:prod`)
  - `BROWSER_CHANNEL=chromium` on Linux if Chrome isn’t installed
  - `BROWSER_USER_DATA_DIR` (absolute path outside the repo) or `PROFILE_DIR` to persist session
  - `DASHBOARD_PORT=3001`, `PORT_UI=3000`
  - `NEXT_PUBLIC_DASHBOARD_URL` if UI and dashboard are on different origins (e.g., `https://api.example.com:3001`). Otherwise reverse‑proxy `/socket.io` to the dashboard.
  - Region: `us-central1` (Cloud Run location)

**Process Manager**
- Use `systemd`/`pm2` to keep processes alive and capture logs.
- Example (pm2):
  - `pm2 start --name xagent "pnpm start:agent:prod"`
  - `pm2 start --name xui "pnpm start"`

**Security**
- Keep secrets in environment/secret store only; do not commit `.env` to VCS.
- Run Chromium with safe flags in containers: `--no-sandbox --disable-dev-shm-usage` (included in `start:agent:prod`).
- Store only essential profile data; avoid heavy caches.

**Notes**
- Local development uses `pnpm dev` (UI only). Use `pnpm dev:all` if you explicitly need UI + Agent together on a developer machine.

**Connectivity (reverse proxy)**
- If you serve UI and dashboard behind a single domain, proxy Socket.IO path to the dashboard:
  - NGINX example:
    - `location /socket.io { proxy_pass http://127.0.0.1:3001; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade"; }`
- If you serve them on different origins, set `NEXT_PUBLIC_DASHBOARD_URL` (and optionally `NEXT_PUBLIC_DASHBOARD_PORT`/`NEXT_PUBLIC_DASHBOARD_PATH`).

**Health & Smoke**
- Health: `GET /api/health` (should return `{ ok: true }`). If using the edge proxy (same origin), call via the LB root domain.
- Live Browser: after deploy, UI should show the Live Browser card with streaming screenshots. Verify Pause/Resume/Reset/Rate controls reflect in UI and logs.

**Playwright runtime**
- On first deploy, install browsers: `pnpm exec playwright install chromium`
- Headless runs require `--no-sandbox --disable-dev-shm-usage` in some containers; already provided by `start:agent:prod`.

**Health**
- Dashboard health: `GET http://host:3001/api/health` → `{ ok, paused, uptime, activeConnections }`.
**Container Build & Push**
- Build the container using the provided `Dockerfile` (bundles Next UI + Agent + Edge proxy):
  - `gcloud config set project google-mpf-172983073065`
  - `gcloud auth configure-docker us-central1-docker.pkg.dev`
  - `gcloud services enable artifactregistry.googleapis.com run.googleapis.com aiplatform.googleapis.com`
  - `gcloud artifacts repositories create xagent --repository-format=docker --location=us-central1 --description="Xagent images"`
  - `docker build -t us-central1-docker.pkg.dev/google-mpf-172983073065/xagent/xagent:prod .`
  - `docker push us-central1-docker.pkg.dev/google-mpf-172983073065/xagent/xagent:prod`
- Required runtime env vars (Cloud Run → set as env or from Secret Manager):
  - `GEMINI_API_KEY` (secret)
  - Optional: `TWITTER_LIST_URL`, `START_URL`, `PROFILE_DIR` (if persistence needed), `BROWSER_CHANNEL=chromium`

**Terraform (infra/terraform)**
- Files extracted under `infra/terraform/` (autogenerated module wiring for Cloud Run, Global LB, Vertex AI, AppHub).
- Adjustments made:
  - Fixed references to variables with hyphens using `var["name-with-hyphen"]` in `infra/terraform/main.tf`.
  - Added `variable "container_image"` and wired `containers = [{ container_image = var.container_image, ... }]`.
- Usage:
  - `cd infra/terraform`
  - Create `prod.tfvars` with required values (see `infra/terraform/input.tfvars` as template), e.g.:
    - `xagent-cloud-run-service_project_id = "PROJECT"`
    - `xagent-vertex-ai_project_id = "PROJECT"`
    - `xagent-global-lb-frontend_project_id = "PROJECT"`
    - `xagent-global-lb-backend_project_id = "PROJECT"`
    - `apphub_project_id = "PROJECT"`
    - `apphub_location = "global"`
    - `apphub_application_id = "lionxa"`
    - `container_image = "us-central1-docker.pkg.dev/PROJECT/xagent/xagent:prod"`
  - Auth: `gcloud auth login` and set project: `gcloud config set project google-mpf-172983073065`
  - `terraform init`
  - `terraform plan -var-file=prod.tfvars`
  - `terraform apply -var-file=prod.tfvars`

Notes:
- The module creates a Global HTTP(S) LB in front of Cloud Run. Set your DNS A/AAAA to the LB IPs from outputs.
- To set environment variables/secrets on Cloud Run via Terraform, extend the `containers` block with `env` entries according to Cloud Run v2 API (or update afterwards with `gcloud run services update`).
