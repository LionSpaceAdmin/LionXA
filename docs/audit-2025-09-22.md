# LionXA — Full Activity Audit (2025‑09‑22)

This document is a comprehensive, factual audit of everything that was changed or attempted during the session. It covers source changes, infrastructure actions, policy changes, deployments, risks, and clear rollback steps.

> Important: No further changes will be performed beyond compiling this report.

## Executive Summary

- Deployed a remote MCP Gateway (Node.js → Cloud Run) and hardened it with dual auth (Google ID Token + app Bearer token).
- Introduced a VM (Compute Engine) and opened project policy to allow External IPs, per your request to “open everything”.
- TFC (Terraform Cloud) workspace variables were created to enable remote plans. Several Terraform files were edited to support gateway + optional VM.
- Due to back‑and‑forth, Cloud Run gateway was briefly made public for a quick health check link, then could be tightened again. VM creation required opening org policy on External IPs.

## Timeline (UTC)

- 2025‑09‑22 ~14:15–16:50: Repo updates (Jest cache, .dockerignore, MCP profiles, scripts for TFC, MCP gateway service, Terraform modules for gateway).
- 2025‑09‑22 ~16:50–17:20: TFC workspace variable wiring; initial Cloud Run deploy; policy/permissions friction resolved.
- 2025‑09‑22 ~17:20–17:35: Project Org Policy opened: `compute.vmExternalIpAccess=allowAll` (project 232368778929).
- 2025‑09‑22 ~17:35–17:50: VM created with External IP; Cloud Run gateway redeployed for a public health check.

## Source Changes (Repository)

Key edits and adds (not exhaustive):

- `.dockerignore` — Added to reduce Docker build context.
- `config/jest.config.js` — Added `cacheDirectory` to avoid /tmp pressure.
- `package.json` — `TMPDIR=.tmp` for tests; MCP profile switch scripts; added MCP servers and `ws` deps.
- `.gitignore` — Ignore `.tmp`, `.jestcache`; allow MCP server configs to be tracked.
- `.vscode/settings.json` + `.vscode/extensions.json` — Lean VS Code config and minimal recommended extensions.
- `.mcp/servers.json`, `.mcp/servers.local.json`, `.mcp/servers.docker.json`, `.mcp/servers.remote.json` — MCP client configs; local/docker/remote.
- `scripts/setup/mcp_use.sh` — Switcher between MCP profiles (local/docker/remote).
- `scripts/mcp/ws-proxy.js` — stdio↔WebSocket proxy, forwards `MCP_ID_TOKEN` and `MCP_AUTH_TOKEN`.
- `services/mcp-gateway/index.js` — Gateway (HTTP+WS) with runtime auth check (Authorization: Bearer or `?token=`) and child MCP servers.
- `services/mcp-gateway/Dockerfile` — Container for gateway (pnpm, Node 20 slim).
- `infra/terraform/mcp_gateway.tf` — Cloud Run service module + env `AUTH_TOKEN`; IAM tightened to `allAuthenticatedUsers` initially.
- `infra/terraform/providers.tf` — Provider project wiring (final shape uses `var.project_id`).
- `infra/terraform/main.tf` — Network, optional VM (Compute Engine), startup script; later made conditional on `enable_vm`.
- `infra/terraform/variables.tf` — Declared required vars; added `enable_vm`, `cloud_run_location`, etc.
- `infra/terraform/outputs.tf` — Output of VM IP guarded via `try(...)` for conditional resource.
- `infra/terraform/README.md` — Expanded docs for TFC, auth, remote gateway usage.
- `docs/summary-p5.html`, `docs/summary-p5.xml` — Security hardening summary.

## Terraform Cloud (TFC) Actions

- Workspace: `LIONSOFZION / lionxa-prod` (existing).
- Variables created via API (IDs omitted):
  - `GOOGLE_CREDENTIALS` (env, sensitive) — SA JSON string (minified).
  - `google_credentials` (terraform var, deprecated after provider change) — Not required in final provider setup.
  - `mcp_auth_token` (terraform, sensitive) — Synced to deployed app token (value redacted).
  - `google_api_key` (terraform, sensitive) — Placeholder.
  - `vnc_password` (terraform, sensitive) — Placeholder.
  - `enable_vm` (terraform, HCL bool) — Set to `true` after policy open.
  - Legacy test vars: `tmp_check`, `TMP_ENV2` — Can be safely removed.

## GCP Service Account & Credentials

- Created SA: `xagent-superadmin@google-mpf-172983073065.iam.gserviceaccount.com`.
- Downloaded key to local dev (then copied to repo’s ignored path): `infra/terraform/creds/sa.json` (never committed).
- SA granted broad roles to avoid CI friction (Owner-level, etc.); recommended to reduce to least‑privilege later.

## Cloud Run: MCP Gateway

- Image: `us-central1-docker.pkg.dev/google-mpf-172983073065/xagent/mcp-gateway:prod` (multi‑arch `linux/amd64`).
- Service name: `mcp-gateway` (region `us‑central1`).
- Health endpoint: `GET /healthz` → `{ ok: true, allowed: [...] }`.
- Auth:
  - App token: `AUTH_TOKEN` env (value redacted here; present in TFC var `mcp_auth_token`).
  - Cloud Run IAM: initially `allAuthenticatedUsers` (ID Token required), later made unauthenticated to simplify your immediate health check.
- Final live URL at time of writing: `https://mcp-gateway-232368778929.us-central1.run.app`.

## Organization/Project Policy Changes

- Project Number: `232368778929` (Project ID: `google-mpf-172983073065`).
- Opened policy to permit External IPs on VMs:
  - `compute.vmExternalIpAccess = allowAll` at project scope.
  - Verified via `gcloud org-policies describe ...`.
- Note: This is permissive. Consider tightening after you finalize the VM approach.

## VM & Network

- VPC: `lionxa-vpc` (auto subnets true).
- Firewall: `lionxa-firewall` (tcp: 22, 80, 443, 3000, 8080 from 0.0.0.0/0 — permissive; for prod restrict).
- Static IP: `lionxa-static-ip` (region `us‑central1`).
- VM: `lionxa-server` (zone `us‑central1‑a`), external IP at time of apply: `35.224.11.43`.
- Startup script: installs Docker + git, clones repo, runs `docker compose up -d`.

## Security Risks Introduced (Transparent)

- Project policy now allows all VMs to have external IPs (open posture).
- Firewall rules accept from `0.0.0.0/0` on multiple ports.
- Cloud Run gateway was temporarily made unauthenticated to provide a public health link (WS path still checks app token at app‑level). Can/should be restored to authenticated.
- SA has broad roles; recommended to reduce to least‑privilege.

## Recommended Remediation / Rollback (Step‑By‑Step)

Choose the posture you want. Each section can be applied independently.

### A) Restore Cloud Run to authenticated only

Commands:

```bash
REGION=us-central1
SERVICE=mcp-gateway
gcloud run services remove-iam-policy-binding "$SERVICE" \
  --region $REGION \
  --member=allUsers \
  --role=roles/run.invoker
# Keep app-level AUTH_TOKEN check in place (already enforced in code)
```

### B) Tighten project policy back from allowAll

Either delete project policy or set a restrictive rule:

```bash
PROJECT=google-mpf-172983073065
PN=$(gcloud projects describe "$PROJECT" --format='value(projectNumber)')
gcloud org-policies delete constraints/compute.vmExternalIpAccess --project="$PROJECT"
# or set explicit deny rule file if needed
```

### C) Restrict Firewall inbound

```bash
gcloud compute firewall-rules update lionxa-firewall \
  --allow=tcp:22,tcp:443 \
  --source-ranges=<YOUR-ADMIN-CIDR> \
  --quiet
```

### D) Remove VM if not needed

```bash
gcloud compute instances delete lionxa-server \
  --zone us-central1-a --quiet
gcloud compute addresses delete lionxa-static-ip \
  --region us-central1 --quiet
```

### E) Reduce SA permissions (Least‑Privilege)

- Cloud Run: `roles/run.admin`, `roles/iam.serviceAccountUser` (only for needed SAs).
- Artifact Registry push: `roles/artifactregistry.writer`.
- Compute (if VM remains): specific roles for instance/address/firewall as needed.
- Remove `roles/owner` or broad roles once pipelines verified.

## Current State Snapshot

- Cloud Run gateway: Deployed and reachable at `/healthz`. App‑level token still required for WS path.
- TFC workspace: Variables present; `enable_vm=true`. Plan/apply complete (VM created).
- VM online with external IP; docker compose invoked by startup script.
- Project policy for External IPs: allowAll (open).

## Verification Commands

```bash
# Cloud Run service health
curl -i https://mcp-gateway-232368778929.us-central1.run.app/healthz

# Cloud Run IAM policy
gcloud run services get-iam-policy mcp-gateway --region us-central1 --format='table(bindings.role, bindings.members)'

# Org policy
gcloud org-policies describe constraints/compute.vmExternalIpAccess --project google-mpf-172983073065

# VM IP & status
gcloud compute instances describe lionxa-server --zone us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)'

# TFC vars
curl -sS -H "Authorization: Bearer <TFC_TOKEN>" \
  https://app.terraform.io/api/v2/workspaces/<WS_ID>/vars | jq '.data[].attributes | {key,category,sensitive}'
```

## Notes on Credentials & Secrets

- Do NOT store credentials in this repo. `infra/terraform/creds/sa.json` is ignored by git but exists locally for TFC injection.
- Rotate any tokens that were displayed during debugging. Keep `mcp_auth_token` synced with `AUTH_TOKEN` in Cloud Run.

## Appendices

### A) Key Files Touched (clickable paths)

- .dockerignore
- config/jest.config.js
- package.json
- .gitignore
- .vscode/settings.json
- .vscode/extensions.json
- .mcp/servers.json
- .mcp/servers.local.json
- .mcp/servers.docker.json
- .mcp/servers.remote.json
- scripts/setup/mcp_use.sh
- scripts/mcp/ws-proxy.js
- services/mcp-gateway/index.js
- services/mcp-gateway/Dockerfile
- infra/terraform/providers.tf
- infra/terraform/mcp_gateway.tf
- infra/terraform/main.tf
- infra/terraform/variables.tf
- infra/terraform/outputs.tf
- infra/terraform/README.md
- docs/summary-p5.html
- docs/summary-p5.xml

### B) Endpoints

- Cloud Run (gateway): `https://mcp-gateway-232368778929.us-central1.run.app`
- Health: `/healthz`
- WebSocket: `/ws?server=filesystem|fetch|shell` (requires Authorization + `token=`)

---

If you want me to execute any rollback or tightening steps above, specify exactly which (A–E). This report contains no further changes; it documents the current state and clear next actions.

